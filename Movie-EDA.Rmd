---
title: "Movie Revenue"
output: pdf_document
---

Packages used for analysis
```{r, message = FALSE}
library(tidyverse)
library(caret)
library(Amelia)
library(stringr)
library(DataExplorer)
library(fastDummies)
library(forcats)
library(purrr)
library(lubridate)
```

Read in the data
```{r, warning=FALSE}
movie_train <- read.csv("train.csv", stringsAsFactors = FALSE, na.strings = c("", NA))
movie_test <- read.csv("test.csv", stringsAsFactors = FALSE, na.strings = c("", NA))
movie_data <- bind_rows(movie_train, movie_test)
```

```{r}
# Drop some variables that we don't need at all initially
movie_data <- movie_data %>% dplyr::select(-imdb_id, -original_title, -overview, -poster_path, -status)

# Change release date to a date
movie_data$release_date <- parse_date_time2(movie_data$release_date, orders = "%m%d%y", cutoff_2000 = 20L)
```

```{r}
# Plots of numeric variables
ggplot(movie_data, aes(x = popularity, y = revenue)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + xlim(0, 300)
ggplot(movie_data, aes(x = runtime, y = revenue)) + geom_point() + geom_smooth(method = "loess", se = FALSE)
ggplot(movie_data, aes(x = budget, y = revenue)) + geom_point() + geom_smooth(method = "loess", se = FALSE)

# Plot of how many values are missing
missmap(movie_data, col = c("red", "navyblue"))
plot_missing(movie_data)
```

Categorical variables
```{r}
# Analyzing features with many NAs

movie_nas <- movie_train[,c("Keywords", "tagline", "homepage", "belongs_to_collection", "revenue")]
movie_nas <- movie_nas %>% mutate_at(.funs = list(cat = ~ifelse(is.na(.), 0, 1)), .vars = c("Keywords", "tagline", "homepage", "belongs_to_collection"))

# Keywords
mean(movie_nas[movie_nas$Keywords_cat == 1,]$revenue, na.rm = TRUE)
mean(movie_nas[movie_nas$Keywords_cat == 0,]$revenue, na.rm = TRUE)

boxplot(revenue~Keywords_cat, data = movie_nas)

# Tagline
mean(movie_nas[movie_nas$tagline_cat == 1,]$revenue)
mean(movie_nas[movie_nas$tagline_cat == 0,]$revenue)

boxplot(revenue~tagline_cat, data = movie_nas)

# Homepage
mean(movie_nas[movie_nas$homepage_cat == 1,]$revenue)
mean(movie_nas[movie_nas$homepage_cat == 0,]$revenue)

boxplot(revenue~homepage_cat, data = movie_nas)

# Collection
mean(movie_nas[movie_nas$belongs_to_collection_cat == 1,]$revenue)
mean(movie_nas[movie_nas$belongs_to_collection_cat == 0,]$revenue)
boxplot(revenue~belongs_to_collection_cat, data = movie_nas)

#
# For each of these features, there is a higher average revenue when not NA than when NA
#

# Add indicator columns to main data
movie_data <- movie_data %>% mutate_at(.funs = list(ind = ~ifelse(is.na(.), 0, 1)), .vars = c("Keywords", "tagline", "homepage", "belongs_to_collection"))

# Drop columns
movie_data <- movie_data %>% select(-belongs_to_collection, -homepage, -tagline, -Keywords)
```

```{r}
# Most of the movies are English, so I'm going to add another indicator variable to specify if the original language was English or not
movie_data <- movie_data %>% mutate(English = ifelse(original_language == "en", 1, 0))

# Drop original langauge column
movie_data <- movie_data %>% select(-original_language)

```

```{r}
# Pulling out just the abbreviations
movie_data$spoken_languages <- sapply(movie_data$spoken_languages, function(x){unlist(str_extract_all(x, '(?<=\')[:lower:]{2}(?=\')'))})
```

```{r}
movie_data <- movie_data %>% mutate(SpEnglish = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'en'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpArabic = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ar'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpKorean = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ko'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpJapanese = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ja'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpRussian = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ru'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpFrench = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'fr'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpItalian = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'it'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpGerman = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'de'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpSpanish = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'es'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpPortugese = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'pt'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpHi = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'hi'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpZh = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'zh'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpLa = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'la'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpHe = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'he'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpQu = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'qu'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpTr = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'tr'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpTa = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ta'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpTe = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'te'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpCn = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'cn'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpGd = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'gd'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpSv = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'sv'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpCs = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'cs'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpHu = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'hu'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpGa = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ga'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpEl = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'el'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpPl = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'pl'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpTl = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'tl'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpTh = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'th'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpNo = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'no'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpDa = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'da'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpNl = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'nl'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpSr = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'sr'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpFa = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'fa'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpXx = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'xx'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpFi = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'fi'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpUr = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ur'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpAm = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'am'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpMi = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'mi'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpMl = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ml'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpBn = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'bn'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpRo = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'ro'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpIu = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'iu'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpId = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'id'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpMr = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'mr'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpAf = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'af'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpXh = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'xh'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpZu = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'zu'))}), 1, 0))
movie_data <- movie_data %>% mutate(SpKn = ifelse(sapply(movie_data$spoken_languages, function(x){any(str_detect(x, 'kn'))}), 1, 0))
any(is.na(movie_data$SpEnglish))
movie_data[is.na(movie_data$SpEnglish),]$spoken_languages
```

```{r}
# Ok this isn't the most efficient way but it works
# Created a variable for total number of languages spoken in a film (Num_Languages)
# movie_data$Num_Languages <- movie_data$SpAf + movie_data$SpAm + movie_data$SpArabic + movie_data$SpBn + movie_data$SpCn + movie_data$SpCs + movie_data$SpDa + movie_data$SpEl + movie_data$SpEnglish + movie_data$SpFa + movie_data$SpFi + movie_data$SpFrench + movie_data$SpGa + movie_data$SpGd + movie_data$SpGerman + movie_data$SpHe + movie_data$SpHi + movie_data$SpHu + movie_data$SpId + movie_data$SpItalian + movie_data$SpIu + movie_data$SpJapanese + movie_data$SpKn + movie_data$SpKorean + movie_data$SpLa + movie_data$SpMi + movie_data$SpMl + movie_data$SpMr + movie_data$SpNl + movie_data$SpNo + movie_data$SpPl + movie_data$SpPortugese + movie_data$SpQu + movie_data$SpRo + movie_data$SpRussian + movie_data$SpSpanish + movie_data$SpSr + movie_data$SpSv + movie_data$SpTa + movie_data$SpTe + movie_data$SpTh + movie_data$SpTl + movie_data$SpTr + movie_data$SpUr + movie_data$SpXh + movie_data$SpXx + movie_data$SpZh + movie_data$SpZu

# Shorter alternative
movie_data$Num_Languages <- movie_data %>%
  select(SpEnglish:SpKn) %>%
  rowSums()
```

```{r}
# Genres
movie_data$genre_list <- sapply(movie_data$genres, function(x){unlist(str_extract_all(x, '(?<=\')([A-Z])\\w+(.*?)(?=\')'))})
dv_g <- qdapTools::mtabulate(movie_data$genre_list) 
colnames(dv_g) <- paste0("Genre", gsub(" ", "", colnames(dv_g)))
rownames(dv_g) <- 1:nrow(dv_g)

movie_data <- cbind(movie_data, dv_g)

# Attempt 2
# 
# pre_genre <- gregexpr(": \'(.*?)}", movie_data$genres)
# pre_genre2 <- regmatches(movie_data$genres, pre_genre)
# genres <- lapply(pre_genre2, function(x) substr(x,4,nchar(x) - 2))
# 
# movie$genre <- genres
# dv <- qdapTools::mtabulate(movie$genre); colnames(dv) <- paste0("Genre", gsub(" ", "", colnames(dv)))
# 
# movie_data <- cbind(movie_data, dv)


# Attempt 1
# 
# pre_genre <- gregexpr(": \'(.*?)}", movie_data$genres)
# pre_genre2 <- regmatches(movie_data$genres, pre_genre)
# genres <- lapply(pre_genre2, function(x) substr(x,4,nchar(x) - 2))
#
# genre_vec <- unlist(genres)
# genre_names <- names(table(genre_vec))
# genre.df <- plyr::ldply(genres, rbind)
# 
# dv <- matrix(0, ncol = length(genre_names), nrow = nrow(movie_data))
# for(i in 1:ncol(genre.df)) {
#   temp <- fastDummies::dummy_cols(genre.df[,i])
#   temp <- temp[,-1]
#   colnames(temp) <- substr(colnames(temp), 7, nchar(colnames(temp)))
#   temp[,setdiff(genre_names, colnames(temp))] <- 0
#   temp <- temp[,genre_names]
#   temp[is.na(temp)] <- 0
#   dv <- dv + temp
# }
# colnames(dv) <- gsub(" ", "",colnames(dv))
# colnames(dv) <- paste0("Genre",colnames(dv))
# movie_data <- cbind(movie_data, dv)

```

```{r country}
# Split apart all of the countries into a separate column
separated <- separate(movie_data, production_countries, sep = "\\}, \\{", into = c("Country1", "Country2", "Country3", "Country4", "Country5", "Country6", "Country7", "Country8", "Country9", "Country10", "Country11", "Country12"))

# Function to extract the country name from the json formatted text
country_name <- function(x) {
    str_extract(x, pattern = "(?<=name': ')[A-Za-z\\s]+")
}

# Apply the function to get the country name to all twelve country columns
countries <- separated %>% select(Country1:Country12) %>% map_df(~country_name(.)) %>% bind_cols(id = separated$id)

# Change any countries that have no production company to none
countries$Country1[is.na(countries$Country1)] <- "None"

# Reshape the data to long format to make country into a factor
countries_long <- countries %>% pivot_longer(Country1:Country12, names_to = "CountryNumber", values_to = "Country", values_drop_na = TRUE)

# Summarizes the number of movies for each country
Country_summary <- countries_long %>% 
  group_by(Country) %>%
  summarize(count = n()) %>% 
  arrange(desc(count))

# Changes countries to a factor. Any country that has less than 100 movies produced there is clumped in the other group
countries_fct <- countries_long %>% 
  mutate(Country = factor(Country),
         Country = fct_lump_min(Country, min = 100, other_level = "Other"))

# Make dummy variables for each country remained (and the None and Other groups)
dummy_many <- countries_fct %>% dummy_cols(select_columns = "Country")

# Combined the multiple observations into a single observation for each row
# Variables are now ready to be included in the model. 
country_dummies <- dummy_many %>% group_by(id) %>% mutate(Country_Australia = sum(Country_Australia),
                                       Country_Canada = sum(Country_Canada),
                                       Country_France = sum(Country_France),
                                       Country_Germany = sum(Country_Germany),
                                       Country_India = sum(Country_India),
                                       Country_Italy = sum(Country_Italy),
                                       Country_Japan = sum(Country_Japan),
                                       Country_Other = sum(Country_Other),
                                       Country_Russia = sum(Country_Russia),
                                       Country_Spain = sum(Country_Spain),
                                       `Country_United Kingdom` = sum(`Country_United Kingdom`),
                                       `Country_United States of America` = sum(`Country_United States of America`),
                                       Country_None = sum(Country_None)) %>% 
                                  distinct(id, .keep_all = TRUE) %>% 
                                  dplyr::select(-CountryNumber, -Country)
movie_data <- movie_data %>% bind_cols(country_dummies)
```

```{r}
# Clean production company data

# Get all companies into a usable list
company_name <- function(x) {
    result <- unlist(str_extract_all(x, pattern = "(?<=name': ')[^']+"))
    result
}
companies <- lapply(movie_data$production_companies, company_name) %>%
  unlist()

# Find most frequently appearing companies
companies_freq <- tibble(company = companies) %>%
  group_by(company) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter(n >= 50 & !is.na(company))
companies_freq

```

```{r}
library(caret)
head(movie_data)
nrow(movie_data)
nrow(movie_test)
nrow(movie_data_1)
nrow(movie.train)
movie_data_1 <- movie_data %>% dplyr::select(-genres, -production_companies, -production_countries, -spoken_languages, -title, -cast, -crew, -genre_list, -id, -id1, -runtime)
custom_summary <- function(data, lev = NULL, model = NULL) {
out <- Metrics::rmsle(data[, "obs"], data[, "pred"])
names(out) <- c("rmsle")
out
}

movie.train <- movie_data_1[!is.na(movie_data_1$revenue),]
movie.test <- movie_data_1[is.na(movie_data_1$revenue),]
myControl <- trainControl(method = "cv",
                          number = 10,
                          summaryFunction = custom_summary)

str(movie.train)
rf.model <- train(revenue~.,
                  data = movie.train,
                  method = "ranger",
                  tuneLength = 2,
                  trControl = myControl,
                  metric = "rmsle",
                  maximize = FALSE,
                  preProcess = c("nzv", "zv", "center", "scale")
)
rf.model

# There is something wrong with the predict here 
preds <- predict(rf.model, newdata = movie.test)
nrow(movie_data_1[is.na(movie_data_1$revenue),])
preds[4398] <- mean(preds)
dat <- data.frame(id = movie_test$id, revenue = preds)
write_csv(dat, "first-preds.csv")
```

